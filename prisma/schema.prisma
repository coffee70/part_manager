// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model CustomerOrder {
  id          Int      @id @default(autoincrement())
  number      String   @unique
  notes       String   @db.Text()
  sectionData Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fields             Json
  statusId           Int?
  status             Status?             @relation(fields: [statusId], references: [id], onDelete: SetNull)
  customerId         Int
  customer           Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerOrderParts CustomerOrderPart[]
  serials            Serial[]
  attachments        Attachment[]
  sections           Section[]

  @@index([statusId], name: "customerOrder_statusId")
}

model ShopOrder {
  id          Int      @id @default(autoincrement())
  number      String   @unique
  notes       String   @db.Text()
  sectionData Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fields Json

  statusId    Int?
  status      Status?      @relation(fields: [statusId], references: [id], onDelete: SetNull)
  serials     Serial[]
  attachments Attachment[]
  sections    Section[]
}

model CustomerOrderPart {
  id        Int      @id @default(autoincrement())
  quantity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customerOrderId Int
  customerOrder   CustomerOrder @relation(fields: [customerOrderId], references: [id], onDelete: Cascade)
  partId          Int
  part            Part          @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([customerOrderId], name: "customerOrderPart_customerOrderId")
  @@index([partId], name: "customerOrderPart_partId")
}

model Part {
  id          Int      @id @default(autoincrement())
  number      String   @unique
  notes       String   @db.Text()
  sectionData Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fields Json

  statusId           Int?
  status             Status?             @relation(fields: [statusId], references: [id], onDelete: SetNull)
  customerOrderParts CustomerOrderPart[]
  serials            Serial[]
  attachments        Attachment[]
  sections           Section[]
}

model Serial {
  id          Int      @id @default(autoincrement())
  number      String
  notes       String   @db.Text()
  sectionData Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fields Json

  partId          Int
  part            Part          @relation(fields: [partId], references: [id], onDelete: Cascade)
  customerOrderId Int
  customerOrder   CustomerOrder @relation(fields: [customerOrderId], references: [id], onDelete: Cascade)
  shopOrderId     Int
  shopOrder       ShopOrder     @relation(fields: [shopOrderId], references: [id], onDelete: Cascade)
  statusId        Int?
  status          Status?       @relation(fields: [statusId], references: [id], onDelete: SetNull)
  attachments     Attachment[]
  sections        Section[]

  @@index([partId], name: "serial_partId")
}

model Customer {
  id          Int      @id @default(autoincrement())
  name        String
  sectionData Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customerOrders CustomerOrder[]
  sections       Section[]
}

model Attachment {
  id       String @id @default(uuid())
  filename String

  serialId        Int?
  serial          Serial?        @relation(fields: [serialId], references: [id], onDelete: Cascade)
  partId          Int?
  part            Part?          @relation(fields: [partId], references: [id], onDelete: Cascade)
  shopOrderId     Int?
  shopOrder       ShopOrder?     @relation(fields: [shopOrderId], references: [id], onDelete: Cascade)
  customerOrderId Int?
  customerOrder   CustomerOrder? @relation(fields: [customerOrderId], references: [id], onDelete: Cascade)
}

enum StatusType {
  CUSTOMER_ORDER
  SHOP_ORDER
  PART
  SERIAL
}

model Status {
  id        Int        @id @default(autoincrement())
  label     String
  color     String
  resolved  Boolean
  type      StatusType
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  fromTransitions Transition[]    @relation("FromStatus")
  toTransitions   Transition[]    @relation("ToStatus")
  customerOrders  CustomerOrder[]
  shopOrders      ShopOrder[]
  parts           Part[]
  serials         Serial[]
}

model Transition {
  id        Int      @id @default(autoincrement())
  label     String   @db.Text()
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fromId Int?
  from   Status? @relation("FromStatus", fields: [fromId], references: [id], onDelete: SetNull)
  toId   Int?
  to     Status? @relation("ToStatus", fields: [toId], references: [id], onDelete: SetNull)
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  TIME
  SELECT
  PARAGRAPH
}

enum FieldModel {
  CUSTOMER_ORDER
  SHOP_ORDER
  PART
  SERIAL
  CUSTOMER
}

model Section {
  id        Int        @id @default(autoincrement())
  title     String
  model     FieldModel
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  fields          Field[]
  CustomerOrder   CustomerOrder? @relation(fields: [customerOrderId], references: [id], onDelete: SetNull)
  customerOrderId Int?
  ShopOrder       ShopOrder?     @relation(fields: [shopOrderId], references: [id], onDelete: SetNull)
  shopOrderId     Int?
  Part            Part?          @relation(fields: [partId], references: [id], onDelete: SetNull)
  partId          Int?
  Serial          Serial?        @relation(fields: [serialId], references: [id], onDelete: SetNull)
  serialId        Int?
  Customer        Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  customerId      Int?

  @@index([customerOrderId], name: "section_customerOrderId")
  @@index([shopOrderId], name: "section_shopOrderId")
  @@index([partId], name: "section_partId")
  @@index([serialId], name: "section_serialId")
  @@index([customerId], name: "section_customerId")
}

model Field {
  id        Int       @id @default(autoincrement())
  name      String
  type      FieldType
  default   Json?
  options   Json?
  multiple  Boolean?
  creative  Boolean?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  sectionId Int
  section   Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
}
